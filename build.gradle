/*
 * This build file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java project to get you started.
 * For more details take a look at the Java Quickstart chapter in the Gradle
 * user guide available at https://docs.gradle.org/4.4.1/userguide/tutorial_java_projects.html
 */

String jruby_jar = "jruby-complete-9.2.14.0.jar"

buildscript {
	repositories {
		jcenter()
	}
	dependencies {
		classpath 'com.github.jengelman.gradle.plugins:shadow:5.2.0'
		classpath 'org.ajoberstar:grgit:1.7.2'
	}
}


//import org.apache.tools.ant.filters.ReplaceTokens

// Apply the java plugin to add support for Java
apply plugin: 'java'
apply plugin: 'com.github.johnrengelman.shadow'

// Apply the application plugin to add support for building an application
apply plugin: 'application'


// In this section you declare where to find the dependencies of your project
repositories {
    // Use jcenter for resolving your dependencies.
    // You can declare any Maven/Ivy/file repository here.
		mavenCentral()
}

ext {
	git = org.ajoberstar.grgit.Grgit.open(file('.'))
	describedCommit = git.describe().toString().trim()
	buildVersion = describedCommit + (describedCommit.matches(".*-[0-9]+-g[0-9a-f]{7}") ? "-SNAPSHOT" : "") + (git.status().isClean() ? "" : "+" + new Date().format("yyyyMMddHHmmss"))
}

dependencies {
    compile 'com.sparkjava:spark-core:2.9.1'
    compile 'com.jcraft:jsch:0.1.55'
	compile 'org.json:json:20190722'
	compile 'org.jruby:jruby-complete:9.2.12.0'
	compile 'org.xerial:sqlite-jdbc:3.30.1'
	compile 'org.slf4j:slf4j-simple:1.7.25'
	compile 'org.slf4j:slf4j-api:1.7.25'
	compile 'org.eclipse.jgit:org.eclipse.jgit:5.7.0.202003110725-r'
	compile 'com.hierynomus:sshj:0.29.0'
	compile group: 'com.esotericsoftware.kryo', name: 'kryo', version: '2.24.0'
	compile 'com.carrotsearch:java-sizeof:0.0.5'
	compile group: 'com.fasterxml.jackson.core', name: 'jackson-core', version: '2.11.3'
	compile group: 'com.fasterxml.jackson.core', name: 'jackson-databind', version: '2.11.3'
}

// Define the main class for the application
//sourceCompatibility ='1.11'
//targetCompatibility = '1.11'
mainClassName = 'jp.tkms.waffle.Main'
applicationDefaultJvmArgs = ["--illegal-access=deny", "--add-opens=java.base/sun.nio.ch=ALL-UNNAMED", "--add-opens=java.base/java.io=ALL-UNNAMED"]

processResources {
	doFirst {
		new File('build/resources/main/version.txt').text = "${buildVersion}"
        /*
		filesMatching("version.txt") {
			filter(ReplaceTokens, tokens: ['build_version': buildVersion])
		}
         */
		println "version -> ${buildVersion}"
	}
	copy {
		from ('sub_project/waffle-virtual-job-executor/build/libs') {
			include 'waffle-virtual-job-executor-all.jar'
		}
		into 'build/resources/main'
	}
	copy {
		from ('./') {
			include 'LICENSE.md'
		}
		into 'build/resources/main'
	}
}
processResources.outputs.upToDateWhen { false }

task createXsub {
	doLast {
		copy {
			from 'xsub'
			into 'build/tmp/xsub_archive/xsub'
		}
	}
	doLast {
		file("build/tmp/xsub_archive/xsub/bin").renameTo(file("build/tmp/xsub_archive/xsub/org_bin"))
	}
	doLast {
		copy {
			from 'src/main/resources/xsub/bin'
			into 'build/tmp/xsub_archive/xsub/bin'
		}
	}
    doLast {
		copy {
			from ('lib') {
				include jruby_jar
			}
			into 'build/tmp/xsub_archive/xsub/bin'
		}
	}
	doLast {
		file("build/tmp/xsub_archive/xsub/bin/" + jruby_jar).renameTo(file("build/tmp/xsub_archive/xsub/bin/jruby-complete.jar"))
	}
}

task createXsubArchive(type: Zip, dependsOn: createXsub) {
	destinationDirectory = file('build/resources/main')
	archiveFileName = 'xsub.zip'
	from 'build/tmp/xsub_archive/'
	excludes = ['.git',]
}

assemble.dependsOn(jar, createXsubArchive)
